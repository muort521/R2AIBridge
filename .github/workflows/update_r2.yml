name: Update Radare2 Core Libraries

# è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘ (æ”¯æŒåœ¨ GitHub ç½‘é¡µç«¯ç‚¹å‡»è¿è¡Œ)
on:
  workflow_dispatch:

# å¿…é¡»èµ‹äºˆå†™å…¥æƒé™ï¼Œä»¥ä¾¿ Actions èƒ½å¤Ÿå°†æ–°çš„ .so æ–‡ä»¶æäº¤å¹¶æ¨é€åˆ°ä»“åº“
permissions:
  contents: write

jobs:
  update-r2-libs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Fetch Latest Radare2 Android aarch64 Release
        run: |
          echo "ğŸš€ è·å– Radare2 æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯..."
          # ä½¿ç”¨ GitHub API è·å–æœ€æ–° Release ä¸­ä»¥ android-aarch64.tar.gz ç»“å°¾çš„ä¸‹è½½é“¾æ¥
          LATEST_URL=$(curl -s https://api.github.com/repos/radareorg/radare2/releases/latest | jq -r '.assets[] | select(.name | test("android-aarch64\\.tar\\.gz$")) | .browser_download_url')
          
          if [ -z "$LATEST_URL" ]; then
            echo "âŒ æœªæ‰¾åˆ°å¯¹åº”çš„ Android aarch64 ä¸‹è½½åŒ…"
            exit 1
          fi
          
          echo "ğŸ“¥ ä¸‹è½½é“¾æ¥: $LATEST_URL"
          wget -qO radare2-latest.tar.gz "$LATEST_URL"

      - name: Extract and Process .so Files
        run: |
          echo "ğŸ§¹ å‡†å¤‡è§£å‹å’Œæå–..."
          TARGET_DIR="app/src/main/jniLibs/arm64-v8a"
          mkdir -p temp_extract
          mkdir -p "$TARGET_DIR"

          # è§£å‹æ–‡ä»¶
          tar -xzf radare2-latest.tar.gz -C temp_extract

          echo "ğŸ” æ­£åœ¨æå–å¹¶æ¸…æ´—æ ¸å¿ƒåº“æ–‡ä»¶..."
          # å¯»æ‰¾çœŸå®çš„å¤§æ–‡ä»¶ï¼Œå‰¥ç¦»ç‰ˆæœ¬å·ï¼Œå¹¶å¤åˆ¶åˆ° jniLibs ç›®å½•
          find temp_extract -type f -name "libr_*.so.*" | while read -r filepath; do
              filename=$(basename "$filepath")
              # æˆªæ–­ .so åé¢çš„ç‰ˆæœ¬å·
              clean_name=$(echo "$filename" | sed 's/\.so\..*/\.so/')
              cp "$filepath" "$TARGET_DIR/$clean_name"
              echo "  âœ”ï¸ å·²æ›´æ–°: $clean_name"
          done

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼Œé˜²æ­¢æ±¡æŸ“ Git å·¥ä½œåŒº
          rm -rf temp_extract radare2-latest.tar.gz

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "build: update radare2 android aarch64 core libraries to latest release"
          file_pattern: "app/src/main/jniLibs/arm64-v8a/*.so"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
