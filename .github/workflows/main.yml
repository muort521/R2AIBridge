name: Android Release Build

on:
  # 当推送以 'v' 开头的标签时触发 (例如 v1.0.0, v3.0)
  push:
    tags:
      - 'v*'
  # 允许手动触发构建 (可以在指定的 Tag 上手动运行以触发覆盖更新)
  workflow_dispatch:

jobs:
  build:
    name: Build & Release APK
    runs-on: ubuntu-latest

    # ✅ 【关键修改】添加写权限，解决 Release Notes 生成失败及覆盖附件的问题
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Restore Keystore file
        # 还原签名文件
        run: |
          mkdir -p keystore
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > keystore/r2aibridge.jks

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Release APK
        # 包含 CMake 编译过程
        run: ./gradlew assembleRelease --stacktrace

      - name: Rename APK
        id: rename_apk
        run: |
          # ✅ 获取当前触发的 Tag 名称 (例如 v1.0.0)
          TAG_NAME=${GITHUB_REF_NAME}
          
          # 将编译出的 apk 重命名为固定格式，方便后续精准覆盖
          APK_NAME="R2AIBridge-${TAG_NAME}-release.apk"
          
          # 找到构建出的 apk 并重命名
          find app/build/outputs/apk/release -name "*-release.apk" -exec mv {} $APK_NAME \;
          echo "apk_path=$APK_NAME" >> $GITHUB_OUTPUT

      - name: Create or Update Release
        uses: softprops/action-gh-release@v2
        # 只在触发源是 Tag 时才执行发布 (包括手动在 Tag 分支上触发)
        if: startsWith(github.ref, 'refs/tags/')
        with:
          # ✅ softprops 插件会自动检测：如果 Tag 已存在，则进入更新模式；遇到同名文件会自动替换
          files: ${{ steps.rename_apk.outputs.apk_path }}
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Artifact (Backup)
        # 备份构建产物到 Actions 页面
        uses: actions/upload-artifact@v4
        with:
          name: r2aibridge-release-apk
          path: ${{ steps.rename_apk.outputs.apk_path }}
