name: Android Release Build

on:
  # 当推送以 'v' 开头的标签时触发 (例如 v1.0.0, v3.0)
  push:
    tags:
      - 'v*'
  # 允许手动触发构建
  workflow_dispatch:

jobs:
  build:
    name: Build & Release APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      # 你的项目使用了 NDK 25.2.9519653，AGP 插件通常会自动下载
      # 但为了保险和速度，我们也可以显式安装（可选，通常 AGP 会自动处理）
      
      - name: Restore Keystore file
        # 关键步骤：还原签名文件
        # Gradle 配置中写的是 file("../keystore/r2aibridge.jks")
        # 假设 build.gradle.kts 在 app/ 目录下，这意味着 keystore 目录在项目根目录
        run: |
          mkdir -p keystore
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > keystore/r2aibridge.jks

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Release APK
        # 你的配置中包含 externalNativeBuild (CMake)，这个过程可能会比较耗时
        run: ./gradlew assembleRelease --stacktrace

      - name: Rename APK
        id: rename_apk
        run: |
          # 找到构建出的 apk (通常在 app/build/outputs/apk/release/)
          # 重命名以便识别，例如 r2aibridge-v3.0.apk
          find . -name "*-release.apk" -exec mv {} r2aibridge-release.apk \;
          echo "apk_path=r2aibridge-release.apk" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ steps.rename_apk.outputs.apk_path }}
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Artifact (Backup)
        # 如果不是打标签触发，或者是为了备份，上传到 Actions Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: r2aibridge-release-apk
          path: ${{ steps.rename_apk.outputs.apk_path }}
