name: Android Release Build

on:
  # 1. å½“æ¨é€ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾æ—¶è‡ªåŠ¨è§¦å‘ (ä¾‹å¦‚ v1.0.0, v3.0)
  push:
    tags:
      - 'v*'
      
  # 2. å…è®¸æ‰‹åŠ¨è§¦å‘ï¼Œå¹¶å¸¦æœ‰ä¸€ä¸ªè¾“å…¥æ¡†è®©æ‚¨å¡«å†™ Tag
  workflow_dispatch:
    inputs:
      custom_tag:
        description: 'æ‰‹åŠ¨æŒ‡å®š Tag åç§° (ä¾‹å¦‚: v1.0.1)'
        required: true
        type: string
        default: 'v1.0.1'

jobs:
  build:
    name: Build & Release APK
    runs-on: ubuntu-latest

    # âœ… æ·»åŠ å†™æƒé™ï¼Œè§£å†³ Release ç”Ÿæˆå’Œè¦†ç›–é™„ä»¶çš„é—®é¢˜
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Restore Keystore file
        # è¿˜åŸç­¾åæ–‡ä»¶
        run: |
          mkdir -p keystore
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > keystore/r2aibridge.jks

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Release APK
        # åŒ…å« CMake ç¼–è¯‘è¿‡ç¨‹
        run: ./gradlew assembleRelease --stacktrace

      - name: Determine Tag and Rename APK
        id: rename_apk
        run: |
          # âœ… æ™ºèƒ½åˆ¤æ–­ Tag æ¥æº
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œä½¿ç”¨è¾“å…¥çš„ Tag
            TAG_NAME="${{ inputs.custom_tag }}"
          else
            # å¦‚æœæ˜¯ git push tag è§¦å‘ï¼Œä½¿ç”¨åŸæœ¬çš„ Tag
            TAG_NAME="${GITHUB_REF_NAME}"
          fi
          
          echo "ğŸ·ï¸ å½“å‰ä½¿ç”¨çš„ Tag ä¸º: $TAG_NAME"
          # å°† TAG_NAME ä¿å­˜åˆ°ç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "CURRENT_TAG=$TAG_NAME" >> $GITHUB_ENV
          
          # è§„èŒƒåŒ– APK å‘½å
          APK_NAME="R2AIBridge-${TAG_NAME}-release.apk"
          
          # æ‰¾åˆ°æ„å»ºå‡ºçš„ apk å¹¶é‡å‘½å
          find app/build/outputs/apk/release -name "*-release.apk" -exec mv {} $APK_NAME \;
          echo "apk_path=$APK_NAME" >> $GITHUB_OUTPUT

      - name: Create or Update Release
        uses: softprops/action-gh-release@v2
        with:
          # âœ… æ˜¾å¼æŒ‡å®š tag_nameï¼Œå¦‚æœ Tag å­˜åœ¨åˆ™è¦†ç›–/æ›´æ–°é™„ä»¶ï¼›å¦‚æœä¸å­˜åœ¨åˆ™è‡ªåŠ¨åˆ›å»º
          tag_name: ${{ env.CURRENT_TAG }}
          files: ${{ steps.rename_apk.outputs.apk_path }}
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Artifact (Backup)
        # å¤‡ä»½æ„å»ºäº§ç‰©åˆ° Actions é¡µé¢
        uses: actions/upload-artifact@v4
        with:
          name: R2AIBridge-${{ env.CURRENT_TAG }}-apk
          path: ${{ steps.rename_apk.outputs.apk_path }}
