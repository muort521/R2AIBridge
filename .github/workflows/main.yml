name: Android Release Build

on:
  # 当推送以 'v' 开头的标签时触发 (例如 v1.0.0, v3.0)
  push:
    tags:
      - 'v*'
  # 允许手动触发构建
  workflow_dispatch:

jobs:
  build:
    name: Build & Release APK
    runs-on: ubuntu-latest

    # ✅ 【关键修改】添加写权限，解决 Release Notes 生成失败的问题
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Restore Keystore file
        # 还原签名文件
        run: |
          mkdir -p keystore
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > keystore/r2aibridge.jks

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Release APK
        # 包含 CMake 编译过程
        run: ./gradlew assembleRelease --stacktrace

      - name: Rename APK
        id: rename_apk
        run: |
          # 找到构建出的 apk 并重命名
          find . -name "*-release.apk" -exec mv {} r2aibridge-release.apk \;
          echo "apk_path=r2aibridge-release.apk" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ steps.rename_apk.outputs.apk_path }}
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Artifact (Backup)
        # 备份构建产物到 Actions 页面
        uses: actions/upload-artifact@v4
        with:
          name: r2aibridge-release-apk
          path: ${{ steps.rename_apk.outputs.apk_path }}